workDir = "/data/workdir"

executor {
    queueSize = 2
    pollInterval = '10sec'
    submitRateLimit = '50/2min'
}

params {

    reference_path = "/home/shared_data_ghi/CWGSMTB/References/NC-000962-3-H37Rv/"
    resource_path = "${params.reference_path}/Annotations/pipeline/ExpandedTruth"
    dbsnp = "${params.reference_path}/Annotations/dbSNP/tbvar/tbvar.v3.vcf"
    reference = "${params.reference_path}/NC-000962-3-H37Rv.fa"
    rrna = "${params.reference_path}/Annotations/pipeline/rRNA.list"

    software_path = "/home/shared_data_ghi/CWGSMTB/Software/"

    //FIXME Move all publishDir related parameters to process-withName section which is fixed in Nextflow v21.10 onwards

    //-----------------------
    // Processes used in MAP_WF and QUANTTB
    //-----------------------

    FASTQC {
        results_dir = "${params.outdir}/fastqc/"
        save_mode = 'copy'
        should_publish = true
        fastqc_path = "${params.software_path}/FastQC-0.11.8/fastqc"
    }

    BWA_MEM {
        results_dir = "${params.outdir}/bwa/mem/"
        save_mode = 'copy'
        should_publish = true
        bwa_path = "${params.software_path}/bwa-0.7.17/bwa"
        samtools_path = "${params.software_path}/samtools-1.9/samtools"
    }

    QUANTTB_QUANT {
        results_dir = "${params.outdir}/quanttb/quant/"
        save_mode = 'copy'
        should_publish = true

        quanttb_venv = "${params.software_path}/FixedQuantTB/"
    }


    //-----------------------
    // Processes used in CALL_WF
    //-----------------------

    SAMTOOLS_MERGE {
        results_dir = "${params.outdir}/samtools/merge/"
        save_mode = 'copy'
        should_publish = true

        samtools_path = "${params.software_path}/samtools-1.9/samtools"
    }

    GATK_MARK_DUPLICATES {
        results_dir = "${params.outdir}/gatk/mark_duplicates/"
        save_mode = 'copy'
        should_publish = true

        gatk_path = "${params.software_path}/gatk-4.2.0.0/gatk"
    }

    GATK_BASE_RECALIBRATOR {
        results_dir = "${params.outdir}/gatk/base_recalibrator/"
        save_mode = 'copy'
        should_publish = true

        gatk_path = "${params.software_path}/gatk-4.2.0.0/gatk"
    }

    GATK_APPLY_BQSR {
        results_dir = "${params.outdir}/gatk/apply_bqsr/"
        save_mode = 'copy'
        should_publish = true

        gatk_path = "${params.software_path}/gatk-4.2.0.0/gatk"
    }

    SAMTOOLS_INDEX {
        results_dir = "${params.outdir}/samtools/index/"
        save_mode = 'copy'
        should_publish = true

        samtools_path = "${params.software_path}/samtools-1.9/samtools"
    }

    GATK_HAPLOTYPE_CALLER {
        results_dir = "${params.outdir}/gatk/haplotype_caller/"
        save_mode = 'copy'
        should_publish = true

        gatk_path = "${params.software_path}/gatk-4.2.0.0/gatk"
        arguments = " -ploidy 1 --read-filter MappingQualityNotZeroReadFilter -G StandardAnnotation -G AS_StandardAnnotation "
    }

    GATK_HAPLOTYPE_CALLER__MINOR_VARIANTS {
        results_dir = "${params.outdir}/gatk/haplotype_caller__minor_variants/"
        save_mode = 'copy'
        should_publish = true

        gatk_path = "${params.software_path}/gatk-4.2.0.0/gatk"
        arguments = " -ploidy 1 \
                      --minimum-mapping-quality 60 \
                      --min-base-quality-score 20 \
                      --read-filter MappingQualityNotZeroReadFilter \
                      -G StandardAnnotation \
                      --output-mode EMIT_ALL_ACTIVE_SITES "
    }

    LOFREQ_CALL__NTM {
        results_dir = "${params.outdir}/lofreq/call__ntm/"
        save_mode = 'copy'
        should_publish = true

        lofreq_path = "${params.software_path}/lofreq-2.1.5/src/lofreq/lofreq"
        arguments = " -m 60 -Q 20 -a 1 "
        region = "1472307-1472307"
    }

    LOFREQ_INDELQUAL {
        results_dir = "${params.outdir}/lofreq/indelqual/"
        save_mode = 'copy'
        should_publish = true

        lofreq_path = "${params.software_path}/lofreq-2.1.5/src/lofreq/lofreq"
        arguments = "-m 60"
    }

    SAMTOOLS_INDEX__LOFREQ {
        results_dir = "${params.outdir}/samtools/index__lofreq/"
        save_mode = 'copy'
        should_publish = true

        samtools_path = "${params.software_path}/samtools-1.9/samtools"
    }

    LOFREQ_CALL {
        results_dir = "${params.outdir}/lofreq/call/"
        save_mode = 'copy'
        should_publish = true

        lofreq_path = "${params.software_path}/lofreq-2.1.5/src/lofreq/lofreq"
        //NOTE: Curretly using default p-value for filtering. XBS_call#L118
        arguments = "-m 60 --call-indels"
    }

    LOFREQ_FILTER {
        results_dir = "${params.outdir}/lofreq/filter/"
        save_mode = 'copy'
        should_publish = true

        lofreq_path = "${params.software_path}/lofreq-2.1.5/src/lofreq/lofreq"
        arguments = "-a 60"
    }

    DELLY_CALL {
        results_dir = "${params.outdir}/delly/call/"
        save_mode = 'copy'
        should_publish = true

        delly_path = "${params.software_path}/delly-v0.8.7/delly_v0.8.7_linux_x86_64bit"
        arguments = "-u 30"
    }

    BCFTOOLS_VIEW {
        results_dir = "${params.outdir}/bcftools/view/"
        save_mode = 'copy'
        should_publish = true

        bcftools_path = "${params.software_path}/bcftools-1.9/bcftools"
    }

    GATK_INDEX_FEATURE_FILE {
        results_dir = "${params.outdir}/gatk/index_feature_file/"
        save_mode = 'copy'
        should_publish = true

        gatk_path = "${params.software_path}/gatk-4.2.0.0/gatk"
    }

    GATK_SELECT_VARIANTS__INTERVALS {
        results_dir = "${params.outdir}/gatk/select_variants__intervals/"
        save_mode = 'copy'
        should_publish = true

        gatk_path = "${params.software_path}/gatk-4.2.0.0/gatk"
    }

    SAMTOOLS_STATS {
        results_dir = "${params.outdir}/samtools/stats/"
        save_mode = 'copy'
        should_publish = true

        samtools_path = "${params.software_path}/samtools-1.9/samtools"
        arguments = "-F DUP,SUPPLEMENTARY,SECONDARY,UNMAP,QCFAIL"
    }

    GATK_COLLECT_WGS_METRICS {
        results_dir = "${params.outdir}/gatk/collect_wgs_metrics/"
        save_mode = 'copy'
        should_publish = true

        gatk_path = "${params.software_path}/gatk-4.2.0.0/gatk"
        arguments = " --READ_LENGTH 0 --COVERAGE_CAP 10000 --COUNT_UNPAIRED"
    }

    GATK_FLAG_STAT {
        results_dir = "${params.outdir}/gatk/flag_stat/"
        save_mode = 'copy'
        should_publish = true

        gatk_path = "${params.software_path}/gatk-4.2.0.0/gatk"
    }

    UTILS_SAMPLE_STATS {
        results_dir = "${params.outdir}/stats/samples/"
        save_mode = 'copy'
        should_publish = true
    }

    UTILS_COHORT_STATS {
        results_dir = "${params.outdir}/stats/cohort/"
        save_mode = 'copy'
        should_publish = true
    }
}


process {
    executor = "pbs" // OR "pbspro"
    queue = "scattergather"
    clusterOptions = "-A GHI -l nodes=1:ppn=8,mem=64g"


    withName: 'QUANTTB*' {
        cpus = 2
        memory = '3 GB'

        beforeScript = "source ${params.quanttb_venv}/activate.sh"
        //NOTE: Uncomment if there is a corresponding activate script which you'd like to run
        // afterScript = "source ${params.quanttb_venv}/deactivate.sh"
    }
}

